use realfft::{RealFftPlanner, RealToComplex};
use rustfft::num_complex::Complex;

const LENGTH: usize = 511;
pub struct FFTProcessor {
    r2c: std::sync::Arc<dyn RealToComplex<f64>>,
    spectrum: Vec<Complex<f64>>,
}

impl FFTProcessor {
    pub fn new(length: usize) -> Self {
        // make a planner
        let mut real_planner = RealFftPlanner::<f64>::new();
        let r2c: std::sync::Arc<dyn RealToComplex<f64>> = real_planner.plan_fft_forward(LENGTH);
        // make a vector for storing the spectrum
        let spectrum = r2c.make_output_vec();
        FFTProcessor { r2c, spectrum }
    }

    pub fn freq_from_fft(&mut self, signal: [isize; LENGTH], sampling_rate: usize) -> f32 {
        // Create input data vector
        let mut indata: Vec<f64> = Vec::new();
        for (i, value) in signal.iter().enumerate() {
            indata.push((*value as f64 * BLACKMAN_HARRIS_WINDOW[i]) as f64);
        }
        // make a vector for storing the spectrum
        //let mut spectrum: Vec<Complex<f64>> = r2c.make_output_vec();

        // forward transform the signal
        self.r2c.process(&mut indata, &mut self.spectrum).unwrap();

        // Find the index of the highest value in the spectrum
        let mut max_value: usize = 0;
        let mut max_index: usize = 0;
        let mut abs_array: [usize; LENGTH] = [0; LENGTH];
        for (i, element) in self.spectrum.iter().enumerate() {
            abs_array[i] = element.norm() as usize;
            if abs_array[i] > max_value {
                max_value = abs_array[i];
                max_index = i;
            }
        }

        // Make a parabolic interpolation for obtaining a real value
        let mut true_i: f32 = max_index as f32;
        // Verify that we have one value before and after the maximum index of the spectrum
        if max_index > 0 && max_index < LENGTH - 1 {
            let prev_idx: usize = max_index.checked_sub(1).unwrap_or(0);
            let next_idx: usize = max_index.checked_add(1).unwrap_or(LENGTH - 1);

            let prev_value: f32 = (abs_array[prev_idx] as f32).log10();
            let next_value: f32 = (abs_array[next_idx] as f32).log10();
            let current_value: f32 = (abs_array[max_index] as f32).log10();

            let numerator: f32 = 0.5 * (prev_value - next_value);
            let denominator: f32 = prev_value - 2.0 * current_value + next_value;

            if denominator != 0.0 {
                true_i = numerator / denominator + max_index as f32;
            }
        }
        sampling_rate as f32 * true_i / LENGTH as f32
    }
}
const BLACKMAN_HARRIS_WINDOW: [f64; 511] = [
    6.0000000000001025e-05,
    6.214774499256615e-05,
    6.860049578833599e-05,
    7.938679977068618e-05,
    9.455423566518545e-05,
    0.0001141694131318767,
    0.0001383179721175555,
    0.0001671045818945928,
    0.00020065293968652906,
    0.00023910576876456056,
    0.00028262481587376133,
    0.0003313908478309105,
    0.00038560364711263777,
    0.0004454820062336027,
    0.0005112637206964241,
    0.0005832055802731037,
    0.0006615833583607771,
    0.0007466917991373143,
    0.0008388446022226069,
    0.000938374404535959,
    0.0010456327590235587,
    0.0011609901099142311,
    0.0012848357641460344,
    0.0014175778585938511,
    0.0015596433227128333,
    0.0017114778362010263,
    0.0018735457812733333,
    0.002046330189125767,
    0.0022303326801619778,
    0.002426073397542753,
    0.0026340909336118956,
    0.0028549422487442267,
    0.003089202582156867,
    0.003337465354216391,
    0.00360034205977455,
    0.0038784621520581938,
    0.00417247291664024,
    0.004483039335014325,
    0.004810843937298677,
    0.0051565866435939346,
    0.005520984593523193,
    0.0059047719634840075,
    0.00630869977114946,
    0.006733535666757681,
    0.007180063710737667,
    0.007649084137227393,
    0.008141413103047382,
    0.008657882421703693,
    0.009199339282006285,
    0.009766645950898468,
    0.01036067946010875,
    0.010982331276248921,
    0.011632506953997852,
    0.012312125772028126,
    0.01302212035134686,
    0.013763436255744322,
    0.014537031574059316,
    0.015343876483993735,
    0.016184952797227082,
    0.017061253485606817,
    0.017973782188209383,
    0.018923552699094754,
    0.01991158843559851,
    0.02093892188703233,
    0.022006594043690507,
    0.023115653806084123,
    0.024267157374356568,
    0.02546216761785647,
    0.02670175342487845,
    0.02798698903260708,
    0.029318953337331907,
    0.030698729185029913,
    0.032127402642444056,
    0.033606062248816196,
    0.035135798248465196,
    0.03671770180443193,
    0.0383528641934462,
    0.04004237598250078,
    0.04178732618735286,
    0.043588801413302423,
    0.04544788497863286,
    0.0473656560211296,
    0.04934318858812579,
    0.051381550710556674,
    0.05348180346153568,
    0.05564499999999996,
    0.057872184600001,
    0.06016439166625121,
    0.06252264473656703,
    0.06494795547188048,
    0.0674413226345208,
    0.07000373105549867,
    0.07263615059155543,
    0.07533953507276694,
    0.0781148212415214,
    0.08096292768371824,
    0.08388475375306037,
    0.08688117848934027,
    0.08995305953164433,
    0.09310123202742479,
    0.09632650753841221,
    0.09962967294436358,
    0.10301148934566379,
    0.10647269096581723,
    0.1100139840548875,
    0.11363604579496009,
    0.1173395232087216,
    0.12112503207226367,
    0.12499315583323686,
    0.12894444453548998,
    0.13297941375134678,
    0.13709854352267975,
    0.14130227731195233,
    0.14559102096440796,
    0.1499651416825937,
    0.15442496701440805,
    0.15897078385587046,
    0.16360283746981044,
    0.16832133052167655,
    0.17312642213366491,
    0.1780182269583646,
    0.18299681427311662,
    0.18806220709627366,
    0.19321438132654747,
    0.19845326490661744,
    0.20377873701216945,
    0.20919062726751883,
    0.2146887149889627,
    0.22027272845699086,
    0.2259423442184688,
    0.23169718641989148,
    0.23753682617278638,
    0.24346078095232412,
    0.24946851403017514,
    0.25555943394262703,
    0.2617328939949522,
    0.2679881918029911,
    0.274324568872888,
    0.2807412102198881,
    0.2872372440270747,
    0.29381174134489474,
    0.3004637158322853,
    0.30719212354018505,
    0.313995862738174,
    0.3208737737849523,
    0.32782463904332876,
    0.334847182840354,
    0.34194007147319055,
    0.3491019132612716,
    0.35633125864526083,
    0.36362660033328015,
    0.370986373494829,
    0.3784089560027751,
    0.3858926687237512,
    0.3934357758572437,
    0.4010364853236144,
    0.4086929492012491,
    0.4164032642129764,
    0.42416547226185153,
    0.431977561016355,
    0.4398374645449974,
    0.4477430640002791,
    0.45569218835190134,
    0.4636826151690688,
    0.47171207145168176,
    0.4797782345101566,
    0.48787873289356565,
    0.4960111473657358,
    0.5041730119288935,
    0.512361814894391,
    0.5205749999999999,
    0.5288099675732048,
    0.53706407573988,
    0.5453346416776834,
    0.5536189429134444,
    0.5619142186637879,
    0.5702176712181662,
    0.5785264673634445,
    0.5868377398491168,
    0.5951485888922013,
    0.6034560837208003,
    0.611757264155277,
    0.6200491422259474,
    0.6283287038261511,
    0.6365929103995086,
    0.6448387006601467,
    0.653062992344619,
    0.6612626839942135,
    0.6694346567663092,
    0.677575776273387,
    0.6856828944482843,
    0.6937528514342371,
    0.7017824774982195,
    0.7097685949660653,
    0.7177080201778194,
    0.7255975654617413,
    0.7334340411253535,
    0.7412142574619055,
    0.7489350267705938,
    0.7565931653888631,
    0.7641854957350837,
    0.7717088483598956,
    0.7791600640044726,
    0.7865359956639628,
    0.7938335106543363,
    0.8010494926808638,
    0.8081808439064393,
    0.8152244870179489,
    0.8221773672888854,
    0.8290364546364012,
    0.8357987456709912,
    0.8424612657369916,
    0.8490210709420919,
    0.8554752501740477,
    0.8618209271027993,
    0.8680552621661973,
    0.8741754545375536,
    0.8801787440732408,
    0.8860624132385818,
    0.8918237890102784,
    0.8974602447536525,
    0.9029692020729843,
    0.9083481326332583,
    0.9135945599516441,
    0.9187060611570684,
    0.9236802687162576,
    0.9285148721246561,
    0.9332076195606575,
    0.9377563195016153,
    0.9421588423001344,
    0.946413121719173,
    0.9505171564245292,
    0.9544690114333152,
    0.958266819517067,
    0.9619087825581758,
    0.9653931728583677,
    0.9687183343980041,
    0.9718826840450198,
    0.9748847127123561,
    0.9777229864628062,
    0.9803961475602216,
    0.9829029154660911,
    0.9852420877805507,
    0.987412541126932,
    0.9894132319790117,
    0.9912431974301784,
    0.9929015559037876,
    0.9943875078040278,
    0.9957003361066841,
    0.9968394068892334,
    0.9978041697997704,
    0.998594158464315,
    0.9992089908321176,
    0.9996483694586303,
    0.9999120817258749,
    1.0,
    0.9999120817258749,
    0.9996483694586303,
    0.9992089908321176,
    0.998594158464315,
    0.9978041697997704,
    0.9968394068892336,
    0.9957003361066842,
    0.9943875078040278,
    0.9929015559037876,
    0.9912431974301784,
    0.9894132319790117,
    0.987412541126932,
    0.9852420877805507,
    0.9829029154660911,
    0.9803961475602216,
    0.9777229864628062,
    0.9748847127123561,
    0.9718826840450198,
    0.9687183343980041,
    0.9653931728583678,
    0.9619087825581758,
    0.958266819517067,
    0.9544690114333152,
    0.9505171564245292,
    0.946413121719173,
    0.9421588423001344,
    0.9377563195016153,
    0.9332076195606575,
    0.9285148721246561,
    0.9236802687162576,
    0.9187060611570684,
    0.9135945599516442,
    0.9083481326332586,
    0.9029692020729843,
    0.8974602447536525,
    0.8918237890102784,
    0.8860624132385818,
    0.8801787440732408,
    0.8741754545375536,
    0.8680552621661973,
    0.8618209271027993,
    0.8554752501740477,
    0.8490210709420919,
    0.8424612657369918,
    0.8357987456709915,
    0.8290364546364012,
    0.8221773672888854,
    0.8152244870179489,
    0.8081808439064393,
    0.8010494926808638,
    0.7938335106543363,
    0.7865359956639628,
    0.7791600640044726,
    0.7717088483598956,
    0.7641854957350837,
    0.7565931653888631,
    0.7489350267705942,
    0.7412142574619058,
    0.7334340411253535,
    0.7255975654617413,
    0.7177080201778194,
    0.7097685949660653,
    0.7017824774982195,
    0.6937528514342371,
    0.6856828944482843,
    0.677575776273387,
    0.6694346567663092,
    0.6612626839942135,
    0.653062992344619,
    0.6448387006601467,
    0.6365929103995086,
    0.6283287038261511,
    0.6200491422259474,
    0.611757264155277,
    0.6034560837208003,
    0.5951485888922013,
    0.5868377398491168,
    0.5785264673634445,
    0.5702176712181662,
    0.5619142186637879,
    0.5536189429134444,
    0.5453346416776834,
    0.5370640757398802,
    0.528809967573205,
    0.5205750000000002,
    0.5123618148943914,
    0.5041730119288939,
    0.49601114736573615,
    0.487878732893566,
    0.47977823451015694,
    0.47171207145168154,
    0.46368261516906845,
    0.4556921883519012,
    0.4477430640002789,
    0.4398374645449971,
    0.4319775610163549,
    0.4241654722618514,
    0.41640326421297624,
    0.4086929492012491,
    0.4010364853236144,
    0.3934357758572437,
    0.3858926687237512,
    0.3784089560027751,
    0.370986373494829,
    0.36362660033328026,
    0.356331258645261,
    0.3491019132612717,
    0.3419400714731907,
    0.33484718284035414,
    0.3278246390433288,
    0.3208737737849524,
    0.31399586273817426,
    0.30719212354018527,
    0.3004637158322855,
    0.29381174134489496,
    0.28723724402707496,
    0.28074121021988785,
    0.27432456887288786,
    0.26798819180299105,
    0.2617328939949521,
    0.2555594339426269,
    0.24946851403017503,
    0.243460780952324,
    0.23753682617278638,
    0.23169718641989148,
    0.2259423442184688,
    0.22027272845699086,
    0.2146887149889627,
    0.20919062726751883,
    0.20377873701216945,
    0.19845326490661752,
    0.19321438132654753,
    0.18806220709627375,
    0.1829968142731167,
    0.1780182269583647,
    0.17312642213366503,
    0.16832133052167672,
    0.16360283746981064,
    0.15897078385587066,
    0.15442496701440822,
    0.14996514168259384,
    0.1455910209644078,
    0.14130227731195216,
    0.13709854352267972,
    0.1329794137513467,
    0.1289444445354899,
    0.12499315583323678,
    0.12112503207226359,
    0.11733952320872151,
    0.11363604579496009,
    0.1100139840548875,
    0.10647269096581723,
    0.10301148934566379,
    0.09962967294436358,
    0.09632650753841221,
    0.09310123202742485,
    0.0899530595316444,
    0.08688117848934031,
    0.08388475375306044,
    0.08096292768371828,
    0.07811482124152147,
    0.07533953507276699,
    0.07263615059155555,
    0.07000373105549874,
    0.06744132263452088,
    0.06494795547188058,
    0.0625226447365671,
    0.0601643916662511,
    0.057872184600001,
    0.05564499999999996,
    0.05348180346153568,
    0.051381550710556674,
    0.04934318858812579,
    0.0473656560211296,
    0.04544788497863286,
    0.043588801413302423,
    0.04178732618735286,
    0.04004237598250078,
    0.0383528641934462,
    0.03671770180443193,
    0.035135798248465196,
    0.033606062248816196,
    0.032127402642444056,
    0.030698729185029913,
    0.029318953337331907,
    0.02798698903260708,
    0.026701753424878495,
    0.02546216761785652,
    0.024267157374356616,
    0.02311565380608417,
    0.022006594043690493,
    0.020938921887032377,
    0.019911588435598454,
    0.01892355269909475,
    0.017973782188209324,
    0.017061253485606817,
    0.016184952797227082,
    0.015343876483993735,
    0.014537031574059316,
    0.013763436255744322,
    0.01302212035134686,
    0.012312125772028126,
    0.011632506953997852,
    0.010982331276248921,
    0.01036067946010875,
    0.009766645950898468,
    0.009199339282006285,
    0.008657882421703693,
    0.008141413103047382,
    0.007649084137227393,
    0.007180063710737667,
    0.006733535666757702,
    0.00630869977114948,
    0.005904771963484028,
    0.005520984593523213,
    0.005156586643593969,
    0.004810843937298725,
    0.004483039335014358,
    0.004172472916640282,
    0.0038784621520582155,
    0.0036003420597745363,
    0.0033374653542163997,
    0.003089202582156867,
    0.0028549422487442267,
    0.0026340909336118956,
    0.002426073397542753,
    0.0022303326801619778,
    0.002046330189125767,
    0.0018735457812733333,
    0.0017114778362010263,
    0.0015596433227128333,
    0.0014175778585938511,
    0.0012848357641460344,
    0.0011609901099142311,
    0.0010456327590235587,
    0.000938374404535959,
    0.0008388446022225653,
    0.0007466917991373143,
    0.0006615833583607893,
    0.0005832055802731037,
    0.0005112637206964622,
    0.00044548200623363045,
    0.0003856036471126742,
    0.00033139084783093825,
    0.0002826248158738099,
    0.00023910576876452587,
    0.0002006529396865516,
    0.00016710458189453208,
    0.0001383179721175555,
    0.0001141694131318767,
    9.455423566518545e-05,
    7.938679977068618e-05,
    6.860049578833599e-05,
    6.214774499256615e-05,
    6.0000000000001025e-05,
];
